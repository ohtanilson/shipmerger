---
title: "Construct and describe share data"
author:
- Suguru Otani^[so19@rice.edu, Rice University]
date: "Oct 22 2020"

output:
  pdf_document:
  #  html_document:
    fig_caption: yes
    latex_engine: xelatex
    #latex_engine: pdflatex
    number_sections: yes
header-includes:

 - \usepackage{float}
 - \usepackage{booktabs}
 - \usepackage{pdfpages}
 - \usepackage{threeparttable}
# - \usepackage{subfig}
# - \setlength{\parindent}{2em}
# - \setlength{\parskip}{0em}
# - \usepackage{setspace}\doublespacing
# - \usepackage[nomarkers]{endfloat}
# - \renewcommand{\efloatseparator}{\medskip}
 - \usepackage[labelfont=bf]{caption}
 - \usepackage{bookmark}
# - \usepackage{xltxtra}
# - \usepackage{zxjatype}
#- \usepackage[ipa]{zxjafont} # it will cause font errors on Otani's Mac 


linkcolor: blue
fontsize: 10pt 
urlcolor: blue
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE)

library(tidyr)
library(dplyr)
library(ggplot2)
library(readr)
library(gridExtra)
library(stargazer)
# search()
```

## Trend of world's shipping tonnage

* Gross Tonnage of Japanese Merchant Vessels from http://www.mlit.go.jp/hakusyo/transport/index1_.htm

* Gross Tonnage of top6 countries from http://www.mlit.go.jp/hakusyo/transport/shouwa41/ind060101/frame.html and Loyd statistics (missing 1961-1963 now)

```{r,echo=FALSE,results = 'hide', out.width="50%"}
data_totaltons <- readr::read_csv("../input/data_totaltons.csv")
d <- data_totaltons %>%
  dplyr::select(-year_j,-Number, -shipping_quantity_world,
                -shipping_quantity_japan, -grosstons_liberia ) %>%
  dplyr::rename(Japan = grosstons_japan,
                UK = grosstons_UK,
                US = grosstons_US,
                Norway = gtosstons_norway,
                Soviet = grosstons_soviet,
                Greek = grosstons_greek) %>% 
  tidyr::gather(key = "variable", value = "value", -year) 
# d2 <- d %>% 
#   group_by(year) %>%
#   summarize(mean_value = mean(value)) %>%
#   # pipe the above data frame into the knitr::kable function
#   knitr::kable()
#theme_set(theme_minimal())
x <- ggplot(d, aes(x = year, y = value)) + 
  geom_line(aes(color = variable), alpha = 0.6) +
  geom_point(aes(shape = variable, color = variable)) +
  theme_minimal() + 
  ggtitle("World's shipping tonnage") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("year") + ylab("shipping tonnage (million tons)") +
  expand_limits(y=0) + 
  geom_vline(xintercept = 1964, linetype = "longdash") + 
  labs(shape = "Country", color = "Country")

figure_name <- "../figuretable/shippingtonnage.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
```

\begin{figure}[!ht]
\begin{center}
\includegraphics[height = 0.37\textheight]{../figuretable/shippingtonnage.png}
\end{center}
\caption{\textbf{The trend of world's shipping gross tonnage(mill tons)}: \textit{Source}: \cite{syuuyaku} which borrows the data of Statistical Tables in Lloyd's Statistics. The data contains only ships whose tonnage sizes are at least 100 ton. }
\label{fg:shippingtonnage}
\end{figure}

```{r}
# g <- ggplot(d, aes(x = year, y = value)) + 
#   geom_line(aes(color = variable), size = 1, alpha = 0.6) + 
#   facet_wrap(~variable) +
#   theme_minimal() + 
#   ggtitle("World's shipping tonnage") +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   xlab("year") + ylab("shipping tonnage (million tons)") + expand_limits(y=0)
# g
```

## Trend of world's freight movement tonnage

* shipping_quantity_japan is from book3 
  + Ministry of Transport Shipping Bureau (missing 1961-1965 now)
  + http://www.mlit.go.jp/hakusyo/transport/index1_.htm
  
```{r }
# d <- data %>%
#   dplyr::select(year, shipping_quantity_world,
#                 shipping_quantity_japan ) %>%
#   tidyr::gather(key = "variable", value = "value", -year)
# theme_set(theme_minimal())
# x <- ggplot(d, aes(x = year, y = value)) + 
#   geom_line(aes(color = variable), size = 1, alpha = 0.7) +
#   theme_minimal() + 
#   ggtitle("World's freight movement tonnage") +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   xlab("year") + ylab("freight movement tonnage (million tons)") +
#   geom_vline(xintercept = 1964, linetype = "longdash")
# #ggplot2::ggsave("freightmovementtonnage.png")
# 
# figure_name <- "figuretable/freightmovementtonnage.png"
# ggsave(filename = figure_name,
#        plot = x,
#        device = "png",
#        width = 10,
#        height = 7)
```


## Trends of the number of shipping firms in Japan

```{r }
data_number_of_firms <- 
  readr::read_csv("../input/number_of_firms.csv")
d <- data_number_of_firms %>%
  dplyr::select(year, number_matched, unmatched ) %>%
  tidyr::gather(key = "variable", value = "value", -year)
theme_set(theme_minimal())
x <- ggplot(d, aes(x = year, y = value)) + 
  geom_line(aes(color = variable), size = 1, alpha = 0.7) +
  theme_minimal() + 
  ggtitle("the number of shipping firms in Japan: (Missing after 1966)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("year") + ylab("the number of firms")
#ggplot2::ggsave("number_of_firms.png")
figure_name <- "../figuretable/number_of_firms.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
```

<!-- \begin{figure}[!ht] -->
<!-- \begin{center} -->
<!-- \includegraphics[height = 0.37\textheight]{figuretable/number_of_firms.png} -->
<!-- \end{center} -->
<!-- \caption{\textbf{aa}.aaa.} -->
<!-- \label{fg:number_of_firms} -->
<!-- \end{figure} -->



## planned shipbuilding

The payment of planned shipbuilding is needed for calculation of the estimated amount of financial support.
* https://www.mlit.go.jp/hakusyo/transport/shouwa39/ind060103/001.html#tabII-(I)-12


```{r }
data_totaltons <- readr::read_csv("../input/data_totaltons.csv")
d <- data_totaltons %>%
  dplyr::select(year, shipping_quantity_world, shipping_quantity_japan ) %>%
  tidyr::gather(key = "variable", value = "value", -year)
theme_set(theme_minimal())
x <- ggplot(d, aes(x = year, y = value)) + 
  geom_line(aes(color = variable), size = 1, alpha = 0.7) +
  theme_minimal() + 
  ggtitle("World's freight movement tonnage") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("year") + ylab("freight movement tonnage (million tons)")

#ggplot2::ggsave("freightmovementtonnage.png")
figure_name <- "../figuretable/freightmovementtonnage.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
```

<!-- \begin{figure}[!ht] -->
<!-- \begin{center} -->
<!-- \includegraphics[height = 0.37\textheight]{figuretable/freightmovementtonnage.png} -->
<!-- \end{center} -->
<!-- \caption{\textbf{aa}.aaa.} -->
<!-- \label{fg:freightmovementtonnage} -->
<!-- \end{figure} -->

Note that `r d %>% count()` is the dimension

# Descriptive data

## descriptive summary
```{r}
# data <- readr::read_csv("200318firmdata.csv")
# data <- data[,-3:-4]
# summary(data)
```

```{r}
#data <- readr::read_csv("200429firmdata.csv")
data <- readr::read_csv("../input/201006firmdata.csv")
data <- data[,-3:-4]
total_ton <- data[,4]+data[,5]+data[,6]+data[,7]
colnames(data)[3:7] = c("type","liner","special","tramper","tanker")
# temp <- application_market_basic_stats %>%
#   tidyr::gather("variable", "value") %>% 
#   dplyr::group_by(variable) %>%
#   dplyr::summarise(
#     N = sum(!is.na(value)),
#     mean = mean(value, na.rm = TRUE), 
#     sd = sd(value, na.rm = TRUE), 
#     min = min(value, na.rm = TRUE),
#     q25 = quantile(value, probs = .25, na.rm = TRUE),
#     q50 = quantile(value, probs = .5, na.rm = TRUE),
#     q75 = quantile(value, probs = .75, na.rm = TRUE),
#     max = max(value, na.rm = TRUE)) %>%
#   dplyr::mutate(
#     mean = format(round(mean, 3), 3),
#     sd = format(round(sd, 3), 3),
#     min = format(round(min, 3), 3),
#     q25 = format(round(q25, 3), 3),
#     q50 = format(round(q50, 3), 3),
#     q75 = format(round(q75, 3), 3),
#     max = format(round(max, 3), 3))
# 
# temp_vacancy_share_prefecture_category_level <- HHI_vacancy_based_prefecture_category_level %>%
#   dplyr::select(market_unique_id1, vacancy_share_prefecture_category_level) %>% 
#   dplyr::group_by(market_unique_id1) %>% 
#   dplyr::summarise(mean_vacancy_share_prefecture_category_level = mean(vacancy_share_prefecture_category_level)) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::select(mean_vacancy_share_prefecture_category_level) %>% 
#   tidyr::gather("variable", "value") %>% 
#   dplyr::group_by(variable) %>%
#   dplyr::summarise(
#     N = sum(!is.na(value)),
#     mean = mean(value, na.rm = TRUE), 
#     sd = sd(value, na.rm = TRUE), 
#     min = min(value, na.rm = TRUE),
#     q25 = quantile(value, probs = .25, na.rm = TRUE),
#     q50 = quantile(value, probs = .5, na.rm = TRUE),
#     q75 = quantile(value, probs = .75, na.rm = TRUE),
#     max = max(value, na.rm = TRUE)) %>%
#   dplyr::mutate(
#     mean = format(round(mean, 3), 3),
#     sd = format(round(sd, 3), 3),
#     min = format(round(min, 3), 3),
#     q25 = format(round(q25, 3), 3),
#     q50 = format(round(q50, 3), 3),
#     q75 = format(round(q75, 3), 3),
#     max = format(round(max, 3), 3)) %>% 
#   dplyr::select(-variable)
# 
# temp_HHI_vacancy_based_prefecture_category_level <- HHI_vacancy_based_prefecture_category_level %>%
#   dplyr::distinct(market_unique_id1, HHI_vacancy_based_prefecture_category_level) %>% 
#   dplyr::select(HHI_vacancy_based_prefecture_category_level) %>% 
#   tidyr::gather("variable", "value") %>% 
#   dplyr::group_by(variable) %>%
#   dplyr::summarise(
#     N = sum(!is.na(value)),
#     mean = mean(value, na.rm = TRUE), 
#     sd = sd(value, na.rm = TRUE), 
#     min = min(value, na.rm = TRUE),
#     q25 = quantile(value, probs = .25, na.rm = TRUE),
#     q50 = quantile(value, probs = .5, na.rm = TRUE),
#     q75 = quantile(value, probs = .75, na.rm = TRUE),
#     max = max(value, na.rm = TRUE)) %>%
#   dplyr::mutate(
#     mean = format(round(mean, 3), 3),
#     sd = format(round(sd, 3), 3),
#     min = format(round(min, 3), 3),
#     q25 = format(round(q25, 3), 3),
#     q50 = format(round(q50, 3), 3),
#     q75 = format(round(q75, 3), 3),
#     max = format(round(max, 3), 3)) %>% 
#   dplyr::select(-variable)
# 
# list_variables <- data.frame(variable = colnames(application_market_basic_stats))
# application_market_basic_stats_table <- list_variables %>% 
#   dplyr::left_join(temp, by = c("variable"="variable")) %>% 
#   dplyr::select(-variable)
# application_market_basic_stats_table <- 
#   rbind(application_market_basic_stats_table, 
#         temp_vacancy_share_prefecture_category_level,
#         temp_HHI_vacancy_based_prefecture_category_level)
# rownames(application_market_basic_stats_table) <-
#   c("Num of job applications",
#     "Posted wage (10,000 JPN Yen)",
#     "Num of employees", 
#     "Job rank D (Director, rank = 9)",
#     "Job rank MG (manager, rank = 8)",
#     "Job rank SL (Senior Leader, rank = 7)",
#     "Job rank L (Leader, rank = 6)",
#     "Job rank JL (Junior Leader, rank = 5)",
#     "Job rank SP (Senior Player, rank = 4)",
#     "Job rank P (Player, rank = 3)",
#     "Job rank JP (Junior Player, rank = 2)",
#     "Job rank A (Associate, rank = 1)",
#     "Second language level",
#     "Required education indicator (high school)",
#     "Required education indicator (vaocational)",
#     "Required education indicator (college)",
#     "Required education indicator (technical)",
#     "Required education indicator (university)",
#     "Required education indicator (postgraduate)",
#     "mean application share",
#     "mean total applications",
#     "HHI application-based",
#     "mean vacancy share",
#     "HHI vacancy-based"
#     )
# 
# 
# # make a latex table
# table_name <-
#   "../figuretable/application_market_basic_stats_table_mean_across_prefecture_category_market_level.tex"
# x <- Hmisc::latex(
#   file = table_name,
#   title = "",
#   booktabs = TRUE,
#   object = application_market_basic_stats_table,
#   col.just = rep("r", dim(application_market_basic_stats_table)[2]),
#   center = "none",
#   table.env = FALSE,
#   cgroupTexCmd = "itshape",
#   colnamesTexCmd = "itshape",
#   collabel.just = rep("r", dim(application_market_basic_stats_table)[2])
# )
```

```{r}
carrier_type_tonnage_table <- data %>% 
  dplyr::select(type, liner, special, tramper, tanker)
data_hist <- reshape2::melt(carrier_type_tonnage_table, "type") %>% 
  dplyr::filter(value >= 0.1) 
#colnames(data)=c("type","liner","special","tramper","tanker")
x <- ggplot(data_hist, aes(x = value, fill = variable)) + 
  geom_histogram(position="dodge", alpha=0.8) +
  #ggtitle("histogram of tonnage sizes") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  xlab("tonnage size") + ylab("count") + 
  labs("carrier type") +
  xlim(0,650000) + labs(fill="carrier type")
g1 <- x
#ggplot2::ggsave("carrier_type_tonnage.png")
figure_name <- "../figuretable/carrier_type_tonnage.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
```

<!-- \begin{figure}[!ht] -->
<!-- \begin{center} -->
<!-- \includegraphics[height = 0.37\textheight]{figuretable/carrier_type_tonnage.png} -->
<!-- \end{center} -->
<!-- \caption{\textbf{Distribution of tonnage size for each carrier type}. aaa.} -->
<!-- \label{fg:carrier_type_tonnage} -->
<!-- \end{figure} -->


# type-based histogram

```{r}
total_tonnage_table <- data %>% 
  dplyr::select(type, liner, special, tramper, tanker) %>% 
  dplyr::filter(is.na(type)!= 1) %>% 
  dplyr::mutate(total = liner + special + tramper + tanker) %>% 
  dplyr::mutate(firm_type = recode(type, 
                                  "合併会社"="main",
                                 "系列会社"="affiliate",
                                 "専属会社"="single-relationship",
                                 "グループ外"="unmatched"
                                 ))
x <- ggplot(total_tonnage_table, aes(x = total, fill = firm_type)) + 
  geom_histogram(position="dodge", alpha=0.8) +
  #ggtitle("histogram of tonnage sizes") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("total tonnage size") + ylab("count") + 
  xlim(0,650000) + labs(col="firm type") +labs(fill = "firm type")
g2 <- x
#ggplot2::ggsave("total_tonnage.png")
figure_name <- "../figuretable/total_tonnage.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
```

<!-- \begin{figure}[!ht] -->
<!-- \begin{center} -->
<!-- \includegraphics[height = 0.37\textheight]{figuretable/total_tonnage.png} -->
<!-- \end{center} -->
<!-- \caption{\textbf{Distribution of total tonnage size across firm types}.aaa.} -->
<!-- \label{fg:total_tonnage} -->
<!-- \end{figure} -->

```{r}
#gridExtra::grid.arrange(g1, g2, nrow = 2)
```

## Groupby histogram

```{r, echo=FALSE, results = 'hide', out.width="50%"}
library(cowplot)
data <- readr::read_csv("../input/201006firmdata.csv")
data <- data %>% 
  dplyr::select(-source_name,-source_data)
data <- data[,-8:-13]
data <- data[,-9]
bank_names = c("Fuji","Kogin","Chogin","Yasuda","Daiichi","Mitsui",
               "MitsuiShintaku","Sumitomo","SumitomoShintaku","Mitsubishi",
               "Kangin","MitsubishiShintaku","Kobe","Daiwa","Sanwa","Tokai",
               "YasudaShintaku","others")
colnames(data)=c("id", "name", "type","liner","special","tramper","tanker",
                 "group",bank_names)

data2 <- data %>% 
  dplyr::filter(is.na(type)!= 1) %>% 
  dplyr::mutate(total = liner + special + tramper + tanker) %>% 
  dplyr::mutate(firm_type = recode(type, 
                                 "合併会社"="main",
                                 "系列会社"="affiliate",
                                 "専属会社"="single-relationship",
                                 "グループ外"="unmatched"
                                 )) %>% 
  dplyr::filter(group != "nodata")
data2$group <- factor(data2$group, 
     levels = c("Nippon Yusen", "Mitsui O.S.K. Lines",
                "Japan Lines", "Kawasaki Kisen Kaisha",
                "Yamashita-Shinnihon Kisen", "Showa Line", "unmatched"))
x <- ggplot(data2, aes(x = total/10000, fill = firm_type)) + 
  geom_histogram(position="dodge", alpha=0.8) +
  #ggtitle("Histogram of tonnage size for each merger group") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("total tonnage size(10000 ton)") +
  xlim(0,70) + ylim(0,7) + labs(fill = "firm type") +
  facet_wrap(vars(group), ncol = 4) + theme(legend.position = c(0.9, 0.2))
g3 <- x 
#ggplot2::ggsave("type_dist_eachgroup.png")
figure_name <- "../figuretable/type_dist_eachgroup.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
```

\begin{figure}[!ht]
\begin{center}
\includegraphics[height = 0.37\textheight]{../figuretable/type_dist_eachgroup.png}
\end{center}
\caption{\textbf{Distribution of tonnage size for each firm type}. Observation unit: the total tonnage size for each firm type of each group.}
\label{fg:type_dist_eachgroup}
\end{figure}


```{r, echo=FALSE, results = 'hide', out.width="50%"}
library(reshape2)
data6 <- dplyr::select(data2, liner, tramper, special, tanker, firm_type, group)
data6 <- reshape2::melt(data6)
x <- ggplot(data6, aes(x = value/10000, fill = variable)) + 
  geom_histogram(position="dodge", alpha=0.8) +
  #ggtitle("Histogram of tonnage size for each merger group") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("total tonnage size(10000 ton)") +
  xlim(0,70) + ylim(0,7) + labs(fill = "carrier type") +
  facet_wrap(vars(group), ncol = 4) + theme(legend.position = c(0.9, 0.2))
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
#ggplot2::ggsave("carrier_dist_eachgroup.png")
figure_name <- "../figuretable/carrier_dist_eachgroup.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
```

\begin{figure}[!ht]
\begin{center}
\includegraphics[height = 0.37\textheight]{../figuretable/carrier_dist_eachgroup.png}
\end{center}
\caption{\textbf{Distribution of tonnage size for each carrier type}. Observation unit: the total tonnage size for each carrier type of each group. }
\label{fg:carrier_dist_eachgroup}
\end{figure}


```{r}
g4_liner <- ggplot(data2, aes(x = liner/10000, fill = group)) + 
  geom_histogram(position="dodge", alpha=0.8) +
  ggtitle("Liner") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("tonnage size(10000 ton)") +
  xlim(0,55) + labs(col="group") +
  theme(legend.position = "none")
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```

```{r}
g4_tramper <- ggplot(data2, aes(x = tramper/10000, fill = group)) + 
  geom_histogram(position="dodge", alpha=0.8) +
  ggtitle("Tramper") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("tonnage size(10000 ton)") +
  xlim(0,55) + labs(col="group") +
  theme(legend.position = "none")
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```

```{r}
g4_special <- ggplot(data2, aes(x = special/10000, fill = group)) + 
  geom_histogram(position="dodge", alpha=0.8) +
  ggtitle("Special") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("tonnage size(10000 ton)") +
  xlim(0,55) + labs(col="group") +
  theme(legend.position = "none")
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```

```{r}
g4_tanker <- ggplot(data2, aes(x = tanker/10000, fill = group)) + 
  geom_histogram(position="dodge", alpha=0.8) 
legend <- cowplot::get_legend(g4_tanker)
g4_tanker <- g4_tanker +
  ggtitle("Tanker") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("tonnage size(10000 ton)") +
  xlim(0,55) + labs(col="group") +
  theme(legend.position = "none")
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```

```{r, echo=FALSE, results = 'hide', out.width="50%"}
if(0){
x <- gridExtra::grid.arrange(g4_liner, g4_tramper, legend,
                        g4_special, g4_tanker,
                        ncol=3, nrow =2)
#ggplot2::ggsave("carrier_dist_total_eachgroup.png",temp_g)
figure_name <- "../figuretable/carrier_dist_total_eachgroup.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
}

```

<!-- \begin{figure}[!ht] -->
<!-- \begin{center} -->
<!-- \includegraphics[height = 0.37\textheight]{figuretable/carrier_dist_total_eachgroup.png} -->
<!-- \end{center} -->
<!-- \caption{\textbf{---------------------}.aaa.} -->
<!-- \label{fg:carrier_dist_total_eachgroup} -->
<!-- \end{figure} -->

## pie charts

```{r}
g5_liner <- ggplot(data2, aes(x ="", y = liner/10000, fill = group)) + 
  geom_bar(width = 1, stat = "identity") +
  ggtitle("Liner") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab("share of tonnage size") + xlab("") +
  coord_polar("y", start=0) +
  theme(legend.position = "none")
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```


```{r}
g5_tramper <- ggplot(data2, aes(x ="", y = tramper/10000, fill = group)) + 
  geom_bar(width = 1, stat = "identity") +
  ggtitle("Tramper") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab("share of tonnage size") + xlab("") +
  coord_polar("y", start=0) +
  theme(legend.position = "none")
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```


```{r}
g5_special <- ggplot(data2, aes(x ="", y = special/10000, fill = group)) + 
  geom_bar(width = 1, stat = "identity") +
  ggtitle("Special") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab("share of tonnage size") + xlab("") +
  coord_polar("y", start=0) +
  theme(legend.position = "none")
#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```

```{r}
g5_tanker <- ggplot(data2, aes(x ="", y = tanker/10000, fill = group)) + 
  geom_bar(width = 1, stat = "identity") +
  ggtitle("Tanker") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab("share of tonnage size") + xlab("") +
  coord_polar("y", start=0)
legend <- cowplot::get_legend(g5_tanker)
g5_tanker <- g5_tanker + theme(legend.position = "none")

#   + ylab("count") + 
#  xlim(0,650000) + labs(col="firm type")
#ggplot2::ggsave("total_tonnage.png")
```


```{r, echo=FALSE, results = 'hide', out.width="50%"}
if(0){
x <- gridExtra::grid.arrange(g5_liner, g5_tramper, legend,
                        g5_special, g5_tanker,
                        ncol=3, nrow =2)
#ggplot2::ggsave("carrier_share_eachgroup.png",temp_g)
figure_name <- "../figuretable/carrier_share_eachgroup.png"
ggsave(filename = figure_name,
       plot = x,
       device = "png",
       width = 10,
       height = 7)
}

```

\begin{figure}[!ht]
\begin{center}
\includegraphics[height = 0.37\textheight]{../figuretable/carrier_share_eachgroup.png}
\end{center}
\caption{\textbf{Shares of each carrier type and each group}. Observation unit: the total tonnage size for each carrier type of each group. }
\label{fg:carrier_share_eachgroup}
\end{figure}


## Regression

```{r, echo=FALSE, results = 'hide', out.width="50%"}
data2 <- data2 %>% 
  dplyr::mutate(HHI = (liner/total)^2+(special/total)^2+
                  (tramper/total)^2+(tanker/total)^2) %>% 
  dplyr::mutate(share_liner = liner/total) %>% 
  dplyr::mutate(share_special = special/total) %>%
  dplyr::mutate(share_tramper = tramper/total) %>% 
  dplyr::mutate(share_tanker = tanker/total)
buyer_id = data2$id
target_id = data2$id
id_new <- expand.grid(buyer_id, target_id)
colnames(id_new) <- c("buyer_id","target_id")
data3 <- id_new %>% 
  dplyr::full_join(data2, by = c("buyer_id" = "id")) %>%
  dplyr::full_join(data2, by = c("target_id" = "id")) %>% 
  dplyr::filter(buyer_id != target_id) %>% 
  #dplyr::select(group.x,group.y) %>% 
  #dplyr::filter(is.na(type)!= 1) %>% 
  dplyr::mutate(match = ifelse(group.x == group.y, 1, 0)) %>% 
  dplyr::mutate(Fuji_xy = ifelse(Fuji.x == Fuji.y, 1, 0)) %>% 
  dplyr::mutate(Kogin_xy = ifelse(Kogin.x == Kogin.y, 1, 0)) %>% 
  dplyr::mutate(Chogin_xy = ifelse(Chogin.x == Chogin.y, 1, 0)) %>% 
  dplyr::mutate(Yasuda_xy = ifelse(Yasuda.x == Yasuda.y, 1, 0)) %>% 
  dplyr::mutate(Daiichi_xy = ifelse(Daiichi.x == Daiichi.y, 1, 0)) %>% 
  dplyr::mutate(Mitsui_xy = ifelse(Mitsui.x == Mitsui.y, 1, 0)) %>% 
  dplyr::mutate(MitsuiShintaku_xy = ifelse(MitsuiShintaku.x == MitsuiShintaku.y, 1, 0)) %>% 
  dplyr::mutate(Sumitomo_xy = ifelse(Sumitomo.x == Sumitomo.y, 1, 0)) %>% 
  dplyr::mutate(SumitomoShintaku_xy = ifelse(SumitomoShintaku.x == SumitomoShintaku.y, 1, 0)) %>% 
  dplyr::mutate(Mitsubishi_xy = ifelse(Mitsubishi.x == Mitsubishi.y, 1, 0)) %>% 
  dplyr::mutate(Kangin = ifelse(Kangin.x == Kangin.y, 1, 0)) %>% 
  dplyr::mutate(MitsubishiShintaku_xy = ifelse(MitsubishiShintaku.x == MitsubishiShintaku.y, 1, 0)) %>% 
  dplyr::mutate(Kobe_xy = ifelse(Kobe.x == Kobe.y, 1, 0)) %>% 
  dplyr::mutate(Daiwa_xy = ifelse(Daiwa.x == Daiwa.y, 1, 0)) %>% 
  dplyr::mutate(Sanwa_xy = ifelse(Sanwa.x == Sanwa.y, 1, 0)) %>%
  dplyr::mutate(Tokai_xy = ifelse(Tokai.x == Tokai.y, 1, 0)) %>% 
  dplyr::mutate(YasudaShintaku_xy = ifelse(YasudaShintaku.x == YasudaShintaku.y, 1, 0)) %>%
  dplyr::mutate(others_xy = ifelse(others.x == others.y, 1, 0)) 
data3 <- data3 %>% 
  replace(is.na(.), 0) %>%
  dplyr::mutate(bank_coverage = Fuji_xy + Kogin_xy +
                  Chogin_xy + Yasuda_xy + Daiichi_xy + Mitsui_xy +
                  MitsuiShintaku_xy + Sumitomo_xy + SumitomoShintaku_xy +
                  Mitsubishi_xy + Kangin + MitsubishiShintaku_xy + Kobe_xy +
                  Daiwa_xy + Sanwa_xy + Tokai_xy + YasudaShintaku_xy + others_xy) %>% 
  dplyr::mutate(bank_coverage_ratio = bank_coverage/19) %>% 
  dplyr::mutate(same_type = ifelse(firm_type.x == firm_type.y, 1, 0))

res1 <- glm(match ~ log(liner.x*liner.y+1) + log(tramper.x*tramper.y+1) +
                 log(special.x*special.y+1)  + log(tanker.x*tanker.y+1)+
                 log(total.x*total.y+1) ,
               data = data3, family = "binomial")
res2 <- glm(match ~ bank_coverage_ratio + log(HHI.x*HHI.y+1) 
                    + log(share_liner.x*share_liner.y+1)
                    + log(share_special.x*share_special.y+1) 
                    + log(share_tramper.x*share_tramper.y+1)
                    + log(share_tanker.x*share_tanker.y+1),
               data = data3, family = "binomial")
res3 <- glm(match ~ log(liner.x*liner.y+1) + log(tramper.x*tramper.y+1) +
                 log(special.x*special.y+1)  + log(tanker.x*tanker.y+1) +
                 log(total.x*total.y+1) + bank_coverage_ratio 
                 + log(HHI.x*HHI.y+1)+
                 + log(share_liner.x*share_liner.y+1)
                 + log(share_special.x*share_special.y+1) 
                 + log(share_tramper.x*share_tramper.y+1)
                 + log(share_tanker.x*share_tanker.y+1),
               data = data3, family = "binomial")
res4 <- glm(match ~ log(liner.x*liner.y+1) + log(tramper.x*tramper.y+1) +
                 log(special.x*special.y+1)  + log(tanker.x*tanker.y+1) +
                 log(total.x*total.y+1) + bank_coverage_ratio + log(HHI.x*HHI.y+1) 
                 + log(share_liner.x*share_liner.y+1)
                 + log(share_special.x*share_special.y+1) 
                 + log(share_tramper.x*share_tramper.y+1)
                 + log(share_tanker.x*share_tanker.y+1)
                 + same_type,
               data = data3, family = "binomial")
res_LPM <- glm(match ~ log(liner.x*liner.y+1) + log(tramper.x*tramper.y+1) +
                 log(special.x*special.y+1)  + log(tanker.x*tanker.y+1) +
                 log(total.x*total.y+1) + bank_coverage_ratio + log(HHI.x*HHI.y+1)+
                 + log(share_liner.x*share_liner.y+1)
                 + log(share_special.x*share_special.y+1) 
                 + log(share_tramper.x*share_tramper.y+1)
                 + log(share_tanker.x*share_tanker.y+1)
                 + same_type,
                 data = data3)
table_name <-
  "../figuretable/regression_matching.tex"
x <- stargazer(res1,res2,res3,res4,res_LPM,
          header = FALSE,
          float = FALSE,
          type = "latex",
          digits = 3,
          dep.var.labels = c("1(match)"),
          covariate.labels = c("log(liner$_{b}$ *liner$_{t}$+1)",
                               "log(tramper$_{b}$ *tramper$_{t}$+1)",
                               "log(special$_{b}$ *special$_{t}$+1)",
                               "log(tanker$_{b}$ *tanker$_{t}$+1)",
                               "log(total$_{b}$ *total$_{t}$+1)",
                               "bank coverage similarity ratio","log(HHI$_{b}$ *HHI$_{t}$+1)",
                               "log(share of liner$_{b}$ *share of liner$_{t}$+1)",
                               "log(share of special$_{b}$ *share of special$_{t}$+1)",
                               "log(share of tramper$_{b}$ *share of tramper$_{t}$+1)",
                               "log(share of tanker$_{b}$ *share of tanker$_{t}$+1)", 
                               "same type","Intercept"),
          add.lines = list(c("Model", "Logit", "Logit",
                             "Logit","Logit","OLS"
                             )),
          omit.stat = c("f", "ll"),
          model.names = FALSE,
          out = table_name
          )
```

\begin{table}[!ht]
\scriptsize
\caption{\textbf{Preliminary regression results for predicting matchings}. Observation unit: a one-to-one matching pair. The sample size is determined by all possible matching pairs from 121 firms in my data set. }
\begin{center}
\input{../figuretable/regression_matching.tex}
\end{center}
\label{tb:regression_matching}
\end{table}

